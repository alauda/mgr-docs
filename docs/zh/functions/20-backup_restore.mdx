---
weight: 20
---
# 备份恢复

## 功能介绍
数据库备份与恢复是确保数据安全和业务连续性的关键功能。通过定期备份数据库，可以在数据丢失、损坏或误操作时快速恢复数据，最大限度地减少业务中断和数据损失。


## 前提条件：

进行备份前，请根据业务数据量准备外接 S3 兼容存储 。

* 外接 S3 存储：S3（Amazon Simple Storage Service）是亚马逊提供的一种对象存储服务。如果您需要将数据备份至自有的 S3 存储桶中，请与管理员确认已将 S3 存储接入您的项目。

### 配置存储信息
<Tabs>
<Tab label="CLI">
创建 s3 secret
```bash
kubectl -n ${namespace} create secret generic ${secret_name} --from-literal=AWS_ACCESS_KEY_ID=${access_key} --from-literal=AWS_SECRET_ACCESS_KEY=${secret_key}
```
</Tab>
<Tab label="Web Console">
进入 **备份中心**->**外接S3存储** 页面，点击创建S3存储，填写对应信息并创建。

确保外接S3存储连通状态显示为访问正常。
</Tab>
</Tabs>

## 操作步骤

### 配置自动备份
<Tabs>
<Tab label="CLI">
在 mysqlschedules 资源 的 spec 中添加自动备份配置信息。
```bash
kubectl patch mysqlschedules -n ${namespace} ${instance_name}-schedule --type='merge' --patch '
spec:
  expiryDays: 7
  full:
    cron: 0 18 * * 6
    enable: true
  incr:
    cron: 0 19 * * 0,1,2,3,4,5
    enable: true
  storage:
    s3:
      bucket: ${bucket}
      endpoint: ${endpoint}
      region: ${region}
      secret:
        name: ${secretName}
'
```
| 参数 | 说明 |
| --- | --- |
| expiryDays | 备份数据的保留天数 |
| full.cron | 全量备份的定时 cron 表达式 |
| incr.cron | 增量备份的定时 cron 表达式 |
| storage.s3.bucket | 存储桶名称 |
| storage.s3.endpoint | S3 存储的 endpoint |
| storage.s3.region | S3 存储的 region |
| storage.s3.secret.name | S3 存储的 secret 名称 |
</Tab>
<Tab label="Web Console">
1. 在左侧导航栏中，单击 **MySQL-MGR**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。
    
3. 在 **备份恢复** 页签中，点击编辑。

4. 开启 **自动备份**，并设置参数。

    **说明**：**存储位置** 为可供当前项目使用的 S3 存储。

5. 单击 **更新**。

**说明**：
  
* 自动备份名称中的时间戳为 UTC 时间（同 Controller Manager），本例中表示此备份于北京时间 2021 年 02 月 02 日 18:00 开始执行。
    
* 如果已到自动备份时间，可实例未处于 **运行中** 状态，平台将等待实例就绪后开始备份。
</Tab>
</Tabs>

### 创建手动备份
:::tip 前提条件
确保实例状态为 **运行中**
:::
<Tabs>
<Tab label="CLI">
1. 创建数据备份
```bash
kubectl -n ${namespace} create -f - <<EOF
apiVersion: mysql.middleware.alauda.io/v1
kind: MySQLBackup
metadata:
  name: ${backup_name}
  namespace: ${namespace}
spec:
  cluster:
    name: ${instance_name}
  storage:
    s3:
      bucket: ${bucket}
      endpoint: ${endpoint}
      region: ${region}
      secret:
        name: ${secret_name}
  type: ${type}
EOF
```
| 参数 | 说明 |
| --- | --- |
| backup_name | 备份资源名称 |
| namespace | 期望备份的实例所在命名空间 |
| instance_name | 期望备份的实例名称 |
| storage.s3.bucket | 存储桶名称 |
| storage.s3.endpoint | S3 存储的 endpoint |
| storage.s3.region | S3 存储的 region |
| storage.s3.secret.name | S3 存储的 secret 名称 |
| type | 备份类型: full 或 increment |
2. 等待备份执行并查看备份状态
```bash
kubectl get MySQLBackup -n ${namespace} ${backup_name}
```
</Tab>
<Tab label="Web Console">
1. 在左侧导航栏中，单击 **MySQL-MGR**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。
    
3. 在 **备份恢复** 页签中，单击 **创建数据备份**。

4. 设置参数，并单击 **创建**。备份耗时与数据量及网络状况有关，请耐心等待。
</Tab>
</Tabs>

### 使用备份进行恢复
<Tabs>
<Tab label="CLI">
1. 创建 MySQLRestore 恢复数据
```bash
kubectl -n ${namespace} create -f - <<EOF
apiVersion: middleware.alauda.io/v1
kind: MySQLRestore
metadata:
  labels:
    mysql/arch: mgr
  name: ${resotre_name}
  namespace: ${namespace}
spec:
  mgr:
    backup:
      name: ${backup_name}
    cluster:
      name: ${target_instance_name}
    source:
      name: ${source_instance_name}
EOF
```
| 参数 | 说明 |
| --- | --- |
| resotre_name | 恢复资源名称 |
| namespace | 期望备份的实例所在命名空间 |
| backup_name | 期望使用的全量备份资源名称 |
| target_instance_name | 期望恢复数据的实例名称 |
| source_instance_name | 使用的备份资源来源的实例名称 |

2. 等待恢复执行并查看恢复状态
```bash
kubectl get MySQLRestore -n ${namespace} ${resotre_name}
```
</Tab>
<Tab label="Web Console">
1. 在左侧导航栏中，单击 **MySQL-MGR**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。
    
3. 在 **备份恢复** 页签中，单击 **恢复**。

4. 选择目标实例，单击 **恢复**。请耐心等待，直至恢复记录为 **恢复成功** 状态。
</Tab>
</Tabs>

### 删除备份
<Tabs>
<Tab label="CLI">
```bash
kubectl delete MySQLBackup -n ${namespace} ${backup_name}
```
</Tab>
<Tab label="Web Console"> 
1. 在左侧导航栏中，单击 **MySQL-MGR**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。

3. 在 **备份恢复** 页签中，单击 **删除**，并确认。

    S3 备份数据删除后，S3 存储中的数据也会删除。

</Tab>
</Tabs>