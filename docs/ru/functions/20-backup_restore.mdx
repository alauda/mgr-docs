---
weight: 20
sourceSHA: 6af895eb73938a389dfc9a635c2a684b60bcd02ed781909ae1b176a936364b2c
---

# Резервное копирование и восстановление

## Введение в функционал

Резервное копирование и восстановление баз данных являются критически важными функциями для обеспечения безопасности данных и непрерывности бизнеса. Регулярное создание резервных копий баз данных позволяет быстро восстанавливать данные в случае потери, повреждения или непреднамеренных действий, тем самым минимизируя перерывы в работе и потерю данных.

## Предварительные требования:

Перед резервным копированием, пожалуйста, подготовьте внешнее хранилище, совместимое с S3, в зависимости от объема бизнес-данных.

- Внешнее S3 хранилище: S3 (Amazon Simple Storage Service) — это объектное хранилище, предоставляемое Amazon. Если вам необходимо создать резервные копии данных в вашем собственном S3 бакете, пожалуйста, подтвердите у администратора, что S3 хранилище было интегрировано с вашим проектом.

### Настройка информации о хранилище

<Tabs>
  <Tab label="CLI">
    Создайте секрет S3

    ```bash
    kubectl -n ${namespace} create secret generic ${secret_name} --from-literal=AWS_ACCESS_KEY_ID=${access_key} --from-literal=AWS_SECRET_ACCESS_KEY=${secret_key}
    ```
  </Tab>

  <Tab label="Web Console">
    Перейдите на страницу **Центр резервного копирования** -> **Внешнее S3 хранилище**, нажмите создать S3 хранилище, заполните соответствующую информацию и создайте.

    Убедитесь, что статус подключения внешнего S3 хранилища отображается как доступный.
  </Tab>
</Tabs>

## Процедура

### Настройка автоматического резервного копирования

<Tabs>
  <Tab label="CLI">
    Добавьте информацию о конфигурации автоматического резервного копирования в спецификацию ресурса mysqlschedules.

    ```bash
    kubectl patch mysqlschedules -n ${namespace} ${instance_name}-schedule --type='merge' --patch '
    spec:
      expiryDays: 7
      full:
        cron: 0 18 * * 6
        enable: true
      incr:
        cron: 0 19 * * 0,1,2,3,4,5
        enable: true
      storage:
        s3:
          bucket: ${bucket}
          endpoint: ${endpoint}
          region: ${region}
          secret:
            name: ${secretName}
    '
    ```

    | Параметр               | Описание                                       |
    | ---------------------- | ---------------------------------------------- |
    | expiryDays             | Срок хранения для резервных данных            |
    | full.cron              | Cron-выражение для полного резервного копирования |
    | incr.cron              | Cron-выражение для инкрементального резервного копирования |
    | storage.s3.bucket      | Имя бакета                                   |
    | storage.s3.endpoint    | Конечная точка S3 хранилища                  |
    | storage.s3.region      | Регион S3 хранилища                          |
    | storage.s3.secret.name | Имя секрета S3 хранилища                     |
  </Tab>

  <Tab label="Web Console">
    1. В левом навигационном меню нажмите **MySQL-MGR**.

    2. Нажмите на ***Имя пространства имен***.

    3. Нажмите на ***Имя экземпляра***.

    4. На вкладке **Резервное копирование и восстановление** нажмите редактировать.

    5. Включите **Автоматическое резервное копирование** и установите параметры.

       **Примечание**: **Расположение хранилища** — это S3 хранилище, доступное для текущего проекта.

    6. Нажмите **Обновить**.

    **Примечание**:

    - Временная метка в имени автоматической резервной копии указана в UTC (так же, как и у диспетчера контроллера), что указывает на то, что это резервное копирование начало выполняться в 18:00 2 февраля 2021 года по пекинскому времени.

    - Если пришло время для автоматического резервного копирования, но экземпляр не находится в состоянии **Работающий**, платформа будет ждать, пока экземпляр будет готов к запуску резервного копирования.
  </Tab>
</Tabs>

### Создание ручного резервного копирования

:::tip Предварительное требование
Убедитесь, что статус экземпляра **Работающий**
:::

<Tabs>
  <Tab label="CLI">
    1. Создайте резервную копию данных

    ```bash
    kubectl -n ${namespace} create -f - <<EOF
    apiVersion: mysql.middleware.alauda.io/v1
    kind: MySQLBackup
    metadata:
      name: ${backup_name}
      namespace: ${namespace}
    spec:
      cluster:
        name: ${instance_name}
      storage:
        s3:
          bucket: ${bucket}
          endpoint: ${endpoint}
          region: ${region}
          secret:
            name: ${secret_name}
      type: ${type}
    EOF
    ```

    | Параметр               | Описание                                                |
    | ---------------------- | -------------------------------------------------------- |
    | backup\_name           | Имя ресурса резервной копии                             |
    | namespace              | Пространство имен, в котором находится экземпляр, подлежащее резервному копированию |
    | instance\_name         | Имя экземпляра, подлежащее резервному копированию       |
    | storage.s3.bucket      | Имя бакета                                            |
    | storage.s3.endpoint    | Конечная точка S3 хранилища                          |
    | storage.s3.region      | Регион S3 хранилища                                  |
    | storage.s3.secret.name | Имя секрета S3 хранилища                              |
    | type                   | Тип резервного копирования: полный или инкрементный    |

    2. Дождитесь завершения резервного копирования и проверьте статус резервного копирования

    ```bash
    kubectl get MySQLBackup -n ${namespace} ${backup_name}
    ```
  </Tab>

  <Tab label="Web Console">
    1. В левом навигационном меню нажмите **MySQL-MGR**.

    2. Нажмите на ***Имя пространства имен***.

    3. Нажмите на ***Имя экземпляра***.

    4. На вкладке **Резервное копирование и восстановление** нажмите **Создать резервную копию**.

    5. Установите параметры и нажмите **Создать**. Время выполнения резервного копирования зависит от объема данных и условий сети, пожалуйста, проявите терпение.
  </Tab>
</Tabs>

### Восстановление из резервной копии

<Tabs>
  <Tab label="CLI">
    1. Создайте MySQLRestore для восстановления данных

    ```bash
    kubectl -n ${namespace} create -f - <<EOF
    apiVersion: middleware.alauda.io/v1
    kind: MySQLRestore
    metadata:
      labels:
        mysql/arch: mgr
      name: ${restore_name}
      namespace: ${namespace}
    spec:
      mgr:
        backup:
          name: ${backup_name}
        cluster:
          name: ${target_instance_name}
        source:
          name: ${source_instance_name}
    EOF
    ```

    | Параметр               | Описание                                                     |
    | ---------------------- | ------------------------------------------------------------ |
    | restore\_name          | Имя ресурса восстановления                                   |
    | namespace              | Пространство имен, в котором находится экземпляр, подлежащее восстановлению |
    | backup\_name           | Полное имя ресурса резервной копии, которое будет использоваться                               |
    | target\_instance\_name | Имя экземпляра, в который необходимо восстановить данные     |
    | source\_instance\_name | Имя экземпляра, из которого была взята резервная копия     |

    2. Дождитесь завершения восстановления и проверьте статус восстановления

    ```bash
    kubectl get MySQLRestore -n ${namespace} ${restore_name}
    ```
  </Tab>

  <Tab label="Web Console">
    1. В левом навигационном меню нажмите **MySQL-MGR**.

    2. Нажмите на ***Имя пространства имен***.

    3. Нажмите на ***Имя экземпляра***.

    4. На вкладке **Резервное копирование и восстановление** нажмите **Восстановление базы данных**.

    5. Выберите целевой экземпляр и нажмите **Восстановить**. Пожалуйста, проявите терпение, пока запись восстановления не покажет **Восстановление успешно**.
  </Tab>
</Tabs>

### Удаление резервной копии

<Tabs>
  <Tab label="CLI">
    ```bash
    kubectl delete MySQLBackup -n ${namespace} ${backup_name}
    ```
  </Tab>

  <Tab label="Web Console">
    1. В левом навигационном меню нажмите **MySQL-MGR**.

    2. Нажмите на ***Имя пространства имен***.

    3. Нажмите на ***Имя экземпляра***.

    4. На вкладке **Резервное копирование и восстановление** нажмите **Удалить** и подтвердите.

       Удаление резервных данных S3 также удалит данные из S3 хранилища.
  </Tab>
</Tabs>
